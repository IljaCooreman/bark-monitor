<html>

<head>
    <title>AudioPlayground</title>
    <style>
        * {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <h3>bark monitor</h3>
    <audio id="myAudio">
        <source src="audio/ilja1.mp3" type="audio/mpeg">
    </audio>
    <div id="total-bark-count"></div>
    <script>
        let totalBarkCount = 0, barkCount = 0;
        const audio = document.getElementById("myAudio");

        const settings = {
            interval: 2000,
            highAmp: 250,
            zeroCrossing: 75,
            barksBeforeAudio: 5,
        }

        var Recording = function (cb) {
            var recorder = null;
            var recording = true;
            var audioInput = null;
            var volume = null;
            var audioContext = null;
            var callback = cb;
            const clapCount = 0;


            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia || navigator.msGetUserMedia;
            if (navigator.getUserMedia) {
                navigator.getUserMedia({ audio: true },
                    function (e) { //success
                        var AudioContext = window.AudioContext || window.webkitAudioContext;
                        audioContext = new AudioContext();
                        volume = audioContext.createGain(); // creates a gain node
                        audioInput = audioContext.createMediaStreamSource(e); // creates an audio node from the mic stream
                        audioInput.connect(volume);// connect the stream to the gain node
                        recorder = audioContext.createScriptProcessor(2048, 1, 1);
                        recorder.onaudioprocess = function (e) {
                            if (!recording) return;
                            var left = e.inputBuffer.getChannelData(0);
                            //var right = e.inputBuffer.getChannelData(1);
                            callback(new Float32Array(left));
                        };
                        volume.connect(recorder);// connect the recorder
                        recorder.connect(audioContext.destination);
                    },
                    function (e) { //failure
                        alert('Error capturing audio.');
                    }
                );
            } else {
                alert('getUserMedia not supported in this browser.');
            }
        };
        var lastClap = (new Date()).getTime();

        function detectClap(data) {

            var t = (new Date()).getTime();
            if (t - lastClap < settings.interval) return false; // minimum time between barks

            var zeroCrossings = 0, highAmp = 0;

            for (var i = 1; i < data.length; i++) {
                if (Math.abs(data[i]) > 0.25) highAmp++; // TWEAK HERE
                if (data[i] > 0 && data[i - 1] < 0 || data[i] < 0 && data[i - 1] > 0) zeroCrossings++;
            }
            if (highAmp > settings.highAmp && zeroCrossings > settings.zeroCrossing) { // TWEAK HERE
                //console.log(highAmp+' / '+zeroCrossings);
                lastClap = t;
                return true;
            }
            return false;
        }
        var rec = new Recording(function (data) {
            console.log(data.length);
            if (detectClap(data)) {
                console.log('bark!');
                totalBarkCount++;
                barkCount++;
                document.getElementById("total-bark-count").innerHTML = `total bark count: ${totalBarkCount}`;
                if (barkCount >= settings.barksBeforeAudio) {
                    audio.play();
                    barkCount = 0;
                }
            }
        });
    </script>
</body>

</html>